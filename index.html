<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Gold, Silver & Exchange Rates â€“ South Africa</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #f9fafb;
      color: #111827;
      line-height: 1.6;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    header h1 {
      font-size: 2.25rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }

    .timestamp {
      font-size: 0.95rem;
      color: #64748b;
      margin-bottom: 1rem;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border: 1px solid #e2e8f0;
      text-align: center;
    }

    .card.gold { background: #fffbeb; border-left: 4px solid #ca8a04; }
    .card.silver { background: #f0f9ff; border-left: 4px solid #0891b2; }

    .card h3 {
      font-size: 1rem;
      color: #475569;
      margin-bottom: 0.75rem;
    }

    .card .value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #0f172a;
    }

    .premium-note {
      font-size: 0.75rem;
      margin-top: 0.5rem;
      color: #975a02;
      font-style: italic;
    }

    .premium-note.silver { color: #0e7490; }

    .message {
      text-align: center;
      padding: 1.5rem;
      font-size: 1.125rem;
      color: #475569;
    }

    .error {
      color: #dc2626;
      background: #fee2e2;
      border-radius: 0.75rem;
    }

    .rate-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
    }

    .rate-card {
      background: white;
      padding: 1.25rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border: 1px solid #e2e8f0;
      text-align: center;
    }

    .rate-card h3 {
      font-size: 1rem;
      color: #475569;
      margin-bottom: 0.5rem;
    }

    .rate-card .value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #0f172a;
    }

    footer {
      text-align: center;
      margin-top: 2.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e2e8f0;
      color: #94a3b8;
      font-size: 0.9rem;
    }

    @media (max-width: 600px) {
      .container { padding: 1.5rem 1rem; }
      header h1 { font-size: 1.8rem; }
      .card .value { font-size: 1.4rem; }
      .rate-card .value { font-size: 1.3rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Live Gold, Silver & Exchange Rates</h1>
      <div class="timestamp" id="timestamp">Loading...</div>
    </header>

    <div id="loading" class="message">Loading prices and rates...</div>
    <div id="error" class="message error" style="display:none;"></div>

    <div id="metals" style="display:none;">
      <div class="cards-grid">
        <div class="card gold">
          <h3>Gold (1oz)</h3>
          <div class="value" id="goldZAR">Râ€”</div>
          <div class="premium-note">0.7% ðŸ“ˆ</div>
        </div>
        <div class="card silver">
          <h3>Silver (1oz)</h3>
          <div class="value" id="silverZAR">Râ€”</div>
          <div class="premium-note silver"> 0.45% ðŸ“ˆ</div>
        </div>
      </div>
    </div>

    <div id="rates" style="display:none;">
      <h2 style="margin-bottom:1.25rem; font-size:1.375rem; color:#1e293b;">Key Exchange Rates</h2>
      <div class="rate-grid" id="rate-grid"></div>
      <div style="text-align:center; margin-top:1rem; font-size:0.85rem; color:#64748b;" id="forexCacheNote"></div>
    </div>

    <footer>
      <p>Â© <span id="year"></span> Powered by digitalhubza.co.za</p>
    </footer>
  </div>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const CACHE_DURATION_MS = 12 * 60 * 60 * 1000; // 12 hours

    function updateTimestamp() {
      const now = new Date();
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      document.getElementById('timestamp').textContent = now.toLocaleString('en-ZA', options);
    }
    updateTimestamp();

    // Cache helper
    function getCachedData(key) {
      const cached = localStorage.getItem(key);
      if (!cached) return null;
      const parsed = JSON.parse(cached);
      if (Date.now() - parsed.timestamp > CACHE_DURATION_MS) {
        localStorage.removeItem(key);
        return null;
      }
      return parsed.data;
    }

    function setCachedData(key, data) {
      localStorage.setItem(key, JSON.stringify({
        data,
        timestamp: Date.now()
      }));
    }

    function formatCacheAge(timestamp) {
      const ageMs = Date.now() - timestamp;
      const hours = Math.floor(ageMs / (60 * 60 * 1000));
      const minutes = Math.floor((ageMs % (60 * 60 * 1000)) / (60 * 1000));
      if (hours > 0) return `Cached ${hours}h ${minutes}m ago`;
      return `Cached ${minutes}m ago`;
    }

    async function fetchAllData() {
      const loading = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const metalsEl = document.getElementById('metals');
      const ratesEl = document.getElementById('rates');
      const rateGrid = document.getElementById('rate-grid');

      const cachedMetals = getCachedData('metals');
      const cachedForex = getCachedData('forex');

      let goldUSD, silverUSD, rates;

      if (cachedMetals) {
        ({ goldUSD, silverUSD } = cachedMetals);
      } else {
        try {
          const metalsRes = await fetch(
            'https://api.metalpriceapi.com/v1/latest?api_key=5c615ae56b52631b8ba5a12d6c0004d2&base=USD&currencies=XAU,XAG'
          );
          if (metalsRes.ok) {
            const metalsData = await metalsRes.json();
            const xau = metalsData.rates?.XAU;
            const xag = metalsData.rates?.XAG;
            goldUSD = xau > 0 ? 1 / xau : 2600;
            silverUSD = xag > 0 ? 1 / xag : 30;
            setCachedData('metals', { goldUSD, silverUSD, timestamp: Date.now() });
          } else {
            throw new Error('Metals API error');
          }
        } catch (e) {
          console.warn('Falling back to defaults for metals');
          goldUSD = 2600;
          silverUSD = 30;
        }
      }

      if (cachedForex) {
        rates = cachedForex.rates;
        document.getElementById('forexCacheNote').textContent = formatCacheAge(cachedForex.timestamp);
      } else {
        try {
          const forexRes = await fetch('https://api.exchangerate-api.com/v4/latest/ZAR');
          if (forexRes.ok) {
            const forex = await forexRes.json();
            rates = forex.rates;
            setCachedData('forex', { rates, timestamp: Date.now() });
            document.getElementById('forexCacheNote').textContent = 'Updated just now';
          } else {
            throw new Error('Forex API error');
          }
        } catch (e) {
          errorEl.textContent = 'âŒ Failed to load exchange rates.';
          errorEl.style.display = 'block';
          console.error(e);
          loading.style.display = 'none';
          return;
        }
      }

      // Apply markups: 4% for gold, 45% for silver (as in your code)
      const usdToZar = 1 / rates.USD;
      let goldZAR = (goldUSD * usdToZar) * 1.07;
      let silverZAR = (silverUSD * usdToZar) * 1.45;

      // âœ… Only update ZAR prices (USD elements removed from DOM)
      document.getElementById('goldZAR').textContent = `R${goldZAR.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('silverZAR').textContent = `R${silverZAR.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

      // Render exchange rates
      const pairs = [
        { label: 'USD â†’ ZAR', value: usdToZar },
        { label: 'EUR â†’ ZAR', value: 1 / rates.EUR },
        { label: 'GBP â†’ ZAR', value: 1 / rates.GBP },
        { label: 'ZAR â†’ USD', value: rates.USD },
        { label: 'ZAR â†’ EUR', value: rates.EUR },
        { label: 'ZAR â†’ GBP', value: rates.GBP },
      ];

      rateGrid.innerHTML = '';
      pairs.forEach(pair => {
        const card = document.createElement('div');
        card.className = 'rate-card';
        card.innerHTML = `
          <h3>${pair.label}</h3>
          <div class="value">${pair.value.toFixed(4)}</div>
        `;
        rateGrid.appendChild(card);
      });

      loading.style.display = 'none';
      metalsEl.style.display = 'block';
      ratesEl.style.display = 'block';
    }

    fetchAllData();
  </script>
</body>
</html>